version: '3.8'

services:
  # ============================================
  # FRONTEND SERVICES
  # ============================================
  
  admin-frontend:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: ecoride-admin
    ports:
      - "8080:80"
    environment:
      - NODE_ENV=production
    networks:
      - ecoride-network
    restart: unless-stopped
    depends_on:
      - gateway

  client-frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: ecoride-client
    ports:
      - "8081:80"
    environment:
      - NODE_ENV=production
      - VUE_APP_API_URL=http://34.9.26.232:8090
      - VUE_APP_WEBSOCKET_STATIONS_URL=http://34.9.26.232:8005
      - VUE_APP_WEBSOCKET_BICYCLES_URL=http://34.9.26.232:8002
    networks:
      - ecoride-network
    restart: unless-stopped
    depends_on:
      - gateway

  # ============================================
  # BACKEND GATEWAY
  # ============================================
  
  gateway:
    image: ecoride/gateway:latest
    container_name: ecoride-gateway
    ports:
      - "8090:8090"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
    networks:
      - ecoride-network
    restart: unless-stopped
    depends_on:
      - eureka

  # ============================================
  # SERVICE DISCOVERY
  # ============================================
  
  eureka:
    image: ecoride/eureka:latest
    container_name: ecoride-eureka
    ports:
      - "8761:8761"
    networks:
      - ecoride-network
    restart: unless-stopped

  # ============================================
  # MICROSERVICES
  # ============================================
  
  estaciones-service:
    image: ecoride/estaciones:latest
    container_name: ecoride-estaciones
    ports:
      - "8005:8005"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/movilidad_sostenible
      - SPRING_RABBITMQ_HOST=rabbitmq
      - MQTT_BROKER_URL=tcp://mosquitto:1883
    networks:
      - ecoride-network
    restart: unless-stopped
    depends_on:
      - postgres
      - rabbitmq
      - mosquitto
      - eureka

  bicis-service:
    image: ecoride/bicis:latest
    container_name: ecoride-bicis
    ports:
      - "8002:8002"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/movilidad_sostenible
      - SPRING_RABBITMQ_HOST=rabbitmq
    networks:
      - ecoride-network
    restart: unless-stopped
    depends_on:
      - postgres
      - rabbitmq
      - eureka

  viaje-service:
    image: ecoride/viaje:latest
    container_name: ecoride-viaje
    ports:
      - "8004:8004"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/movilidad_sostenible
    networks:
      - ecoride-network
    restart: unless-stopped
    depends_on:
      - postgres
      - eureka

  usuario-service:
    image: ecoride/usuario:latest
    container_name: ecoride-usuario
    ports:
      - "8003:8003"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/movilidad_sostenible
    networks:
      - ecoride-network
    restart: unless-stopped
    depends_on:
      - postgres
      - eureka

  # ============================================
  # INFRASTRUCTURE
  # ============================================
  
  postgres:
    image: postgres:15-alpine
    container_name: ecoride-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=movilidad_sostenible
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - ecoride-network
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: ecoride-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - ecoride-network
    restart: unless-stopped

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: ecoride-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - ecoride-network
    restart: unless-stopped

networks:
  ecoride-network:
    driver: bridge

volumes:
  postgres-data:
  rabbitmq-data:
