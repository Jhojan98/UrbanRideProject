services:
  postgres17:
    container_name: postgres17
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_ROOT_USER}
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      POSTGRES_DB: ${POSTGRES_ROOT_DB}
    ports:
      - "5532:5432"
    volumes:
      - data-postgres:/var/lib/postgresql/data
      - ./docker/postgres/version4.0/initdb:/docker-entrypoint-initdb.d
    networks:
      - movilidad-sostenible-network
    restart: always

  rabbitmq:
    container_name: rabbitmq-server
    image: rabbitmq:4.1.5-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    networks:
      - movilidad-sostenible-network
    restart: always

  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto:2
    # ATENCIÓN: si ya tienes mosquitto en el host usando 1883, comenta la línea de puertos abajo para evitar conflicto
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto:/mosquitto
    networks:
      - movilidad-sostenible-network
    restart: always

  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:26.4.5
    command:
     - start-dev
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KC_ADMIN_USER}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KC_ADMIN_PASSWORD}

      # CONFIG BD
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres17:5432/keycloak
      KC_DB_USERNAME: ${KC_DB_USER}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}
    expose:
      - 8080
    ports:
      - "8080:8080"
    depends_on:
      - postgres17
    networks:
      - movilidad-sostenible-network
    restart: always

  eureka-server:
    container_name: eureka-server
    build:
      context: ./
      dockerfile: ./eureka-server/Dockerfile
    ports:
      - "8761:8761"
    environment:
      PORT: 8761
    networks:
      - movilidad-sostenible-network
    depends_on:
      - postgres17
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/eureka/apps"]
      interval: 5s
      timeout: 3s
      retries: 5

  usuario-service:
    container_name: usuario-service
    build:
      context: ./
      dockerfile: ./usuario-service/Dockerfile
    ports:
      - "8001:8001"
    environment:
      PORT: 8001
      DB_HOST: postgres17:5432
      POSTGRES_DB: movilidad_sostenible
      POSTGRES_USER: ${USUARIO_DB_USER}
      POSTGRES_PASSWORD: ${USUARIO_DB_PASSWORD}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_DEFAULT_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_DEFAULT_PASS}
    networks:
      - movilidad-sostenible-network
    depends_on:
      postgres17:
        condition: service_started
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    restart: always

  email-service:
    container_name: email-service
    build:
      context: ./
      dockerfile: ./email-service/Dockerfile
    ports:
      - "8004:8004"
    environment:
      PORT: 8004
      DB_HOST: postgres17:5432
      POSTGRES_DB: movilidad_sostenible
      POSTGRES_USER: ${EMAIL_DB_USER}
      POSTGRES_PASSWORD: ${EMAIL_DB_PASSWORD}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_DEFAULT_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_DEFAULT_PASS}
    networks:
      - movilidad-sostenible-network
    depends_on:
      - postgres17
      - eureka-server
      - rabbitmq
    restart: always

  bicis-service:
    container_name: bicis-service
    build:
      context: ./
      dockerfile: ./bicis-service/Dockerfile
    ports:
      - "8002:8002"
    environment:
      PORT: 8002
      DB_HOST: postgres17:5432
      POSTGRES_DB: movilidad_sostenible
      POSTGRES_USER: ${BICIS_DB_USER}
      POSTGRES_PASSWORD: ${BICIS_DB_PASSWORD}
      MQTT_BROKER_URL: tcp://mosquitto:1883
      MQTT_QOS: 1
      MQTT_CLIENT_ID: "bicis-service-${HOSTNAME:-local-dev}"
    networks:
      - movilidad-sostenible-network
    depends_on:
      - postgres17
      - eureka-server
      - mosquitto
    restart: always

  bicycle-service:
    container_name: bicycle-service
    build:
      context: ../microservices/bicycle
      dockerfile: Dockerfile
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "5002"]
    ports:
      - "5002:5002"
    environment:
      SERVICE_PORT: 5002
      SERVICE_HOST: bicycle-service
      EUREKA_HOST: eureka-server
      EUREKA_PORT: 8761
      EUREKA_APP_NAME: bicycle-service
      EUREKA_HEARTBEAT_INTERVAL: 30
      POSTGRES_HOST: postgres17:5432
      POSTGRES_DB: movilidad_sostenible
      POSTGRES_USER: ${BICIS_DB_USER}
      POSTGRES_PASSWORD: ${BICIS_DB_PASSWORD}
    networks:
      - movilidad-sostenible-network
    depends_on:
      postgres17:
        condition: service_started
      eureka-server:
        condition: service_healthy
    restart: always

  viaje-service:
    container_name: viaje-service
    build:
      context: ./
      dockerfile: ./viaje-service/Dockerfile
    ports:
      - "8003:8003"
    environment:
      PORT: 8003
      DB_HOST: postgres17:5432
      POSTGRES_DB: movilidad_sostenible
      POSTGRES_USER: ${VIAJE_DB_USER}
      POSTGRES_PASSWORD: ${VIAJE_DB_PASSWORD}
    networks:
      - movilidad-sostenible-network
    depends_on:
      - postgres17
      - usuario-service
      - bicis-service
    restart: always

  gateway-server:
    container_name: gateway-server
    build:
      context: ./
      dockerfile: ./gateway-server/Dockerfile
    expose:
      - 8090
    ports:
      - "8090:8090"
    environment:
      SERVER_PORT: 8090
      USUARIO_SERVICE_URL: http://usuario-service:8001
      BICIS_SERVICE_URL: http://bicis-service:8002
      VIAJE_SERVICE_URL: http://viaje-service:8003
      EMAIL_SERVICE_URL: http://email-service:8004
      ESTACIONES_SERVICE_URL: http://estaciones-service:8005
      CIUDAD_SERVICE_URL: http://ciudad-service:8006

      EUREKA_HOST: eureka-server
      EUREKA_PORT: 8761
    networks:
      - movilidad-sostenible-network
    depends_on:
      keycloak:
        condition: service_started
      eureka-server:
        condition: service_healthy
    restart: always


  estaciones-service:
    container_name: estaciones-service
    build:
      context: ./
      dockerfile: ./estaciones-service/Dockerfile
    ports:
      - "8005:8005"
    environment:
      PORT: 8005
      DB_HOST: postgres17:5432
      POSTGRES_DB: movilidad_sostenible
      POSTGRES_USER: ${ESTACIONES_DB_USER}
      POSTGRES_PASSWORD: ${ESTACIONES_DB_PASSWORD}
      EUREKA_HOST: eureka-server
      EUREKA_PORT: 8761
    networks:
      - movilidad-sostenible-network
    depends_on:
      - postgres17
      - eureka-server
    restart: always

  ciudad-service:
    container_name: ciudad-service
    build:
      context: ./
      dockerfile: ./ciudad-service/Dockerfile
    ports:
      - "8006:8006"
    environment:
      PORT: 8006
      DB_HOST: postgres17:5432
      POSTGRES_DB: movilidad_sostenible
      POSTGRES_USER: ${CIUDAD_DB_USER}
      POSTGRES_PASSWORD: ${CIUDAD_DB_PASSWORD}
      EUREKA_HOST: eureka-server
      EUREKA_PORT: 8761
    networks:
      - movilidad-sostenible-network
    depends_on:
      - postgres17
      - eureka-server
    restart: always

  payment-service:
    container_name: payment-service
    build:
      context: ./
      dockerfile: ./payment-service/Dockerfile
    ports:
      - "8007:8007"
    environment:
      PORT: 8007
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      EUREKA_HOST: eureka-server
      EUREKA_PORT: 8761
    networks:
      - movilidad-sostenible-network
    depends_on:
      - eureka-server
    restart: always

volumes:
  data-postgres:
    name: data-postgres

networks:
  movilidad-sostenible-network:
    driver: bridge